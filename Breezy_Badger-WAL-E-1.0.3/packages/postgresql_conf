#!/usr/bin/env python
# coding=UTF-8

import os
import sys

PG_HOME = os.environ['POSTGRES_DATA_FOLDER']


def error():
    print 'Usage:'
    print 'l: show postgresql.conf content'
    print 'a: adds hash-separated lines to [postgresql.conf | recovery.conf], for example postgresql_conf a "listen_addresses='*'#shared_buffers=128MB"'
    print 'd: deletes hash-separated lines from pg_hba.conf, for example postgresql_conf d "listen_addresses='*'#shared_buffers=128MB"'
    sys.exit(1)


# Check if the number of arguments
if len(sys.argv) < 4:
    error()

# List command
if sys.argv[2] == 'l':
    try:
        f = open(os.path.join(PG_HOME, sys.argv[1]), 'r')
        print f.read()
        f.close()

    except:
        error()

    sys.exit(0)

# Add command
if sys.argv[2] == 'a':
    try:
        entries = sys.argv[3].split('#')
        f = open(os.path.join(PG_HOME, sys.argv[1]), 'a')

        for i in entries:
            f.write('%s\n' % i)

        f.close()
    except:
        error()

    sys.exit(0)

# Delete command
if sys.argv[2] == 'd':
    try:
        entries = sys.argv[3].split('#')
        f = open(os.path.join(PG_HOME, sys.argv[1]), 'r')
        lines = []

        for line in f:
            if line.rstrip('\n') not in entries:
                lines.append(line)

        f.close()
        f = open(os.path.join(PG_HOME, sys.argv[1]), 'w')

        for line in lines:
            f.write('%s' % line)

        f.close()

    except:
        error()

    sys.exit(0)
